version: '3.8'

services:
  printernizer:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: printernizer:latest
    container_name: printernizer
    restart: unless-stopped

    # Environment configuration
    environment:
      # Application settings
      - ENVIRONMENT=production
      - DEPLOYMENT_MODE=docker
      - DEBUG=false
      - LOG_LEVEL=info

      # Server configuration
      - HOST=0.0.0.0
      - PORT=8000

      # German business settings
      - TIMEZONE=Europe/Berlin
      - CURRENCY=EUR
      - VAT_RATE=0.19
      - BUSINESS_LOCATION=Kornwestheim, Deutschland

      # Database
      - DATABASE_PATH=/app/data/printernizer.db

      # File paths
      - DOWNLOADS_PATH=/app/printer-files
      - LIBRARY_PATH=/app/data/library

      # Timelapse paths
      - TIMELAPSE_ENABLED=false
      - TIMELAPSE_SOURCE_FOLDER=/app/data/timelapse-images
      - TIMELAPSE_OUTPUT_FOLDER=/app/data/timelapses

      # CORS (add your domains)
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8000

      # Printer settings
      - PRINTER_POLLING_INTERVAL=30
      - MAX_CONCURRENT_DOWNLOADS=5

      # Printer discovery settings
      - DISCOVERY_ENABLED=true
      - DISCOVERY_TIMEOUT_SECONDS=10
      - DISCOVERY_SCAN_INTERVAL_MINUTES=60

      # WebSocket support
      - ENABLE_WEBSOCKETS=true

      # Feature flags
      - ENABLE_3D_PREVIEW=true
      - ENABLE_ANALYTICS_EXPORT=true
      - ENABLE_BUSINESS_REPORTS=true

    # Port mapping
    ports:
      - "8000:8000"

    # Volume mapping for persistent data
    volumes:
      # Database and application data
      - printernizer-data:/app/data
      # Configuration files (CRITICAL: printers.json must persist)
      - ../config:/app/config
      # Downloaded printer files
      - printernizer-printer-files:/app/printer-files
      # Application logs
      - printernizer-logs:/app/logs
      # Database backups
      - printernizer-backups:/app/backups
      # Preview cache
      - printernizer-cache:/app/data/preview-cache

    # Network configuration
    # IMPORTANT: For printer discovery to work, you may need to use host networking mode
    # This allows the container to access multicast traffic (SSDP/mDNS)
    # Note: host networking doesn't work on Windows Docker Desktop
    # network_mode: host
    networks:
      - printernizer-network

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (optional, adjust as needed)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

# Named volumes for data persistence
volumes:
  printernizer-data:
    driver: local
  printernizer-printer-files:
    driver: local
  printernizer-logs:
    driver: local
  printernizer-backups:
    driver: local
  printernizer-cache:
    driver: local

# Network configuration
networks:
  printernizer-network:
    driver: bridge
