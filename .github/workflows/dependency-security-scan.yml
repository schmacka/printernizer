# Dependency Security Scanning
# Checks for known security vulnerabilities in Python dependencies
# Runs on schedule and can be triggered manually

name: Dependency Security Scan

on:
  schedule:
    # Run every Monday at 9:00 AM Berlin time (7:00 UTC)
    - cron: '0 7 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'requirements.txt'
      - 'requirements-test.txt'
      - '.github/workflows/dependency-security-scan.yml'

jobs:
  python-security:
    name: Python Dependency Security
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit on requirements.txt
        id: pip-audit-main
        continue-on-error: true
        run: |
          pip-audit \
            --requirement requirements.txt \
            --format json \
            --output pip-audit-main.json \
            --desc on \
            --cache-dir .pip-audit-cache

          # Also generate human-readable output
          pip-audit \
            --requirement requirements.txt \
            --format markdown \
            --output pip-audit-main.md \
            --desc on \
            --cache-dir .pip-audit-cache

      - name: Run pip-audit on requirements-test.txt
        id: pip-audit-test
        continue-on-error: true
        run: |
          pip-audit \
            --requirement requirements-test.txt \
            --format json \
            --output pip-audit-test.json \
            --desc on \
            --cache-dir .pip-audit-cache || true

      - name: Check for vulnerabilities
        id: check-vulnerabilities
        run: |
          # Count vulnerabilities from JSON output
          if [ -f pip-audit-main.json ]; then
            VULN_COUNT=$(python3 -c "
          import json
          with open('pip-audit-main.json') as f:
              data = json.load(f)
              print(len(data.get('dependencies', [])))
          " 2>/dev/null || echo "0")

            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

            if [ "$VULN_COUNT" -gt "0" ]; then
              echo "::warning::Found $VULN_COUNT vulnerable dependencies"
              echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            else
              echo "::notice::No vulnerabilities found"
              echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      - name: Create vulnerability summary
        if: always()
        run: |
          echo "## ðŸ”’ Dependency Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-vulnerabilities.outputs.has_vulnerabilities }}" == "true" ]; then
            echo "âš ï¸ **Warning**: Found ${{ steps.check-vulnerabilities.outputs.vulnerability_count }} vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ -f pip-audit-main.md ]; then
              echo "### Vulnerabilities in requirements.txt" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat pip-audit-main.md >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **Success**: No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Last scanned: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-security-scan
          path: |
            pip-audit-main.json
            pip-audit-main.md
            pip-audit-test.json

      - name: Create issue for vulnerabilities
        if: steps.check-vulnerabilities.outputs.has_vulnerabilities == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const vulnCount = '${{ steps.check-vulnerabilities.outputs.vulnerability_count }}';

            let body = `## ðŸ”’ Security Alert: Vulnerable Dependencies Detected\n\n`;
            body += `The weekly security scan found **${vulnCount}** vulnerable dependencies.\n\n`;

            // Read markdown report if available
            if (fs.existsSync('pip-audit-main.md')) {
              const report = fs.readFileSync('pip-audit-main.md', 'utf8');
              body += `### Vulnerability Report\n\n${report}\n\n`;
            }

            body += `### Action Required\n\n`;
            body += `1. Review the vulnerabilities in the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            body += `2. Update affected dependencies\n`;
            body += `3. Test the updates thoroughly\n`;
            body += `4. Dependabot may have already created PRs for some of these issues\n\n`;
            body += `---\n`;
            body += `*This issue was automatically created by the dependency security scan workflow.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Security Alert: Vulnerable Dependencies')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Updated Security Scan\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Security Alert: Vulnerable Dependencies Detected',
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }

  # Check for outdated dependencies
  outdated-check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for outdated packages
        id: outdated
        continue-on-error: true
        run: |
          pip list --outdated --format=json > outdated-packages.json

          # Generate human-readable output
          echo "# Outdated Python Packages" > outdated-packages.md
          echo "" >> outdated-packages.md
          pip list --outdated --format=columns >> outdated-packages.md

      - name: Create outdated packages summary
        if: always()
        run: |
          echo "## ðŸ“¦ Outdated Packages Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f outdated-packages.json ]; then
            OUTDATED_COUNT=$(python3 -c "
          import json
          with open('outdated-packages.json') as f:
              data = json.load(f)
              print(len(data))
          " 2>/dev/null || echo "0")

            if [ "$OUTDATED_COUNT" -gt "0" ]; then
              echo "â„¹ï¸ **Info**: Found $OUTDATED_COUNT outdated packages" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              if [ -f outdated-packages.md ]; then
                cat outdated-packages.md >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… **Success**: All packages are up to date" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload outdated packages report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: outdated-packages
          path: |
            outdated-packages.json
            outdated-packages.md
