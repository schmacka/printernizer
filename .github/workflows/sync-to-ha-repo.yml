name: Sync to HA Add-on Repository

# This workflow automatically synchronizes code from the main printernizer repository
# to the separate printernizer-ha repository for Home Assistant add-on distribution.
#
# Sync Strategy:
# - master branch ‚Üí printernizer-ha/master (production releases)
# - development branch ‚Üí printernizer-ha/development (testing)
# - Versions tied to main repo (src/main.py)
# - Auto-sync on every commit to monitored files

on:
  push:
    branches:
      - master
      - development
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'migrations/**'
      - 'database_schema.sql'
      - 'requirements.txt'
      - 'CHANGELOG.md'
      - '.github/workflows/sync-to-ha-repo.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-to-ha-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout main printernizer repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version info

      - name: Checkout printernizer-ha repository
        uses: actions/checkout@v4
        with:
          repository: schmacka/printernizer-ha
          token: ${{ secrets.HA_REPO_TOKEN }}
          path: ha-repo
          ref: ${{ github.ref_name }}  # Match branch name (master/development)
          fetch-depth: 0

      - name: Configure Git for HA repo
        run: |
          cd ha-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if HA repo branch exists
        id: check_branch
        run: |
          cd ha-repo
          if git ls-remote --heads origin ${{ github.ref_name }} | grep -q ${{ github.ref_name }}; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "Branch ${{ github.ref_name }} exists in HA repo"
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "Branch ${{ github.ref_name }} does not exist in HA repo, will create it"
          fi

      - name: Create branch if needed
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          cd ha-repo
          git checkout -b ${{ github.ref_name }}
          echo "Created new branch: ${{ github.ref_name }}"

      - name: Sync files to HA repository
        run: |
          echo "Syncing files from printernizer to printernizer-ha..."

          # Remove old synced content (but keep HA-specific files)
          rm -rf ha-repo/src ha-repo/frontend ha-repo/migrations
          rm -f ha-repo/database_schema.sql ha-repo/requirements.txt

          # Copy fresh content from main repo
          cp -r src/ ha-repo/src/
          cp -r frontend/ ha-repo/frontend/
          cp -r migrations/ ha-repo/migrations/
          cp database_schema.sql ha-repo/
          cp requirements.txt ha-repo/
          cp CHANGELOG.md ha-repo/

          echo "‚úÖ Files synchronized successfully"

      - name: Extract version from main repository
        id: version
        run: |
          # Extract version from src/main.py
          VERSION=$(grep "APP_VERSION = get_version(fallback=" src/main.py | grep -oP 'fallback="\K[^"]+')

          if [ -z "$VERSION" ]; then
            echo "‚ùå Error: Could not extract version from src/main.py"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Extracted version: $VERSION"

      - name: Update HA config version (master branch only)
        if: github.ref == 'refs/heads/master'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update version in config.yaml
          sed -i "s/^version: .*/version: \"$VERSION\"/" ha-repo/config.yaml

          echo "‚úÖ Updated config.yaml version to: $VERSION"

      - name: Set development version (development branch only)
        if: github.ref == 'refs/heads/development'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEV_VERSION="${VERSION}-dev"

          # Update version in config.yaml with -dev suffix
          sed -i "s/^version: .*/version: \"$DEV_VERSION\"/" ha-repo/config.yaml

          echo "‚úÖ Updated config.yaml version to: $DEV_VERSION"

      - name: Check for changes
        id: check_changes
        run: |
          cd ha-repo

          if git diff --quiet && git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected after sync"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected after sync"

            # Show what changed
            echo "üìù Changed files:"
            git status --short
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd ha-repo

          # Stage all changes
          git add .

          # Double-check there are actually staged changes
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No staged changes to commit, skipping..."
            exit 0
          fi

          # Determine version info for commit message
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            BRANCH_INFO="Production"
            VERSION="${{ steps.version.outputs.version }}"
          else
            BRANCH_INFO="Development"
            VERSION="${{ steps.version.outputs.version }}-dev"
          fi

          # Get short SHA from main repo
          SHORT_SHA="${GITHUB_SHA:0:7}"

          # Create commit message
          git commit -m "$(cat <<EOF
chore: Auto-sync from printernizer@${SHORT_SHA} (${BRANCH_INFO})

Synced version: ${VERSION}
Source commit: ${GITHUB_SHA}
Source branch: ${{ github.ref_name }}
Triggered by: ${{ github.actor }}

ü§ñ Automated sync via GitHub Actions
EOF
)"

          # Push to HA repo
          git push origin ${{ github.ref_name }}

          echo "‚úÖ Changes committed and pushed to printernizer-ha/${{ github.ref_name }}"

      - name: Create sync summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd ha-repo

          echo "## ‚úÖ Home Assistant Add-on Sync Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Repository**: schmacka/printernizer-ha" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Commit**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Synced Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ src/ (complete directory)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ frontend/ (complete directory)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ migrations/ (complete directory)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ database_schema.sql" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ requirements.txt" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff HEAD~1 --stat 2>/dev/null || echo "Initial sync or new branch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "## ‚ÑπÔ∏è No Sync Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: schmacka/printernizer-ha" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Home Assistant add-on code is already up to date." >> $GITHUB_STEP_SUMMARY
