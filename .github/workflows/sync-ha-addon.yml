name: Sync Home Assistant Add-on

# Branching Strategy:
# - master branch: Production HA add-on (auto version bump)
# - development branch: Testing HA add-on changes (no version bump)
# - feature/fix branches: Testing specific changes (no version bump)

on:
  push:
    branches:
      - master
      - development
      - 'feature/**'
      - 'fix/**'
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'scripts/deployment/sync-ha-addon.sh'
      - '.github/workflows/sync-ha-addon.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version bumping
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for source changes (before sync)
        id: check_source_changes
        run: |
          # Check if src/ or frontend/ changed in this push
          if git diff --quiet HEAD~1 HEAD -- src/ frontend/; then
            echo "source_changed=false" >> $GITHUB_OUTPUT
            echo "No changes in source directories (src/ or frontend/)"
          else
            echo "source_changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in source directories (src/ or frontend/)"
          fi

      - name: Run sync script
        run: |
          chmod +x scripts/deployment/sync-ha-addon.sh
          ./scripts/deployment/sync-ha-addon.sh

      - name: Check for sync changes
        id: check_changes
        run: |
          if git diff --quiet printernizer/src printernizer/frontend; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected after sync"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected after sync"
          fi

      - name: Bump HA Add-on version
        if: (steps.check_source_changes.outputs.source_changed == 'true' || steps.check_changes.outputs.changes == 'true') && github.ref == 'refs/heads/master'
        run: |
          # Read current version from config.yaml
          CURRENT_VERSION=$(grep "^version:" printernizer/config.yaml | awk '{print $2}' | tr -d '"')
          echo "Current version: $CURRENT_VERSION"

          # Increment patch version (e.g., 2.0.31 -> 2.0.32)
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          echo "New version: $NEW_VERSION"

          # Update version in config.yaml
          sed -i "s/^version: .*/version: \"$NEW_VERSION\"/" printernizer/config.yaml

          # Extract changes from main CHANGELOG.md or recent commits
          DATE=$(date +%Y-%m-%d)

          # Try to extract unreleased changes from main CHANGELOG.md
          UNRELEASED_CHANGES=$(awk '/## \[Unreleased\]/,/## \[/ {print}' CHANGELOG.md | sed -n '/## \[Unreleased\]/,/## \[/{//!p;}' | sed '/^$/d' | head -30)

          if [ -n "$UNRELEASED_CHANGES" ]; then
            # Use unreleased changes from main CHANGELOG
            echo "Using changes from main CHANGELOG [Unreleased] section"
            {
              echo "## [$NEW_VERSION] - $DATE"
              echo ""
              echo "$UNRELEASED_CHANGES"
              echo ""
            } | cat - printernizer/CHANGELOG.md > printernizer/CHANGELOG.md.tmp
            mv printernizer/CHANGELOG.md.tmp printernizer/CHANGELOG.md
          else
            # Fall back to commit messages if no unreleased changes
            echo "No unreleased changes found, extracting from recent commits"
            COMMIT_MESSAGES=$(git log --pretty=format:"- %s" --no-merges HEAD~5..HEAD | grep -v "Auto-sync\|chore:" || echo "- Source code synchronized from main repository")

            {
              echo "## [$NEW_VERSION] - $DATE"
              echo ""
              echo "$COMMIT_MESSAGES"
              echo ""
            } | cat - printernizer/CHANGELOG.md > printernizer/CHANGELOG.md.tmp
            mv printernizer/CHANGELOG.md.tmp printernizer/CHANGELOG.md
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_source_changes.outputs.source_changed == 'true' || steps.check_changes.outputs.changes == 'true'
        run: |
          git add printernizer/src/ printernizer/frontend/

          # Add version files if they were modified
          if [ -f printernizer/config.yaml ]; then
            git add printernizer/config.yaml printernizer/CHANGELOG.md || true
          fi

          # Create commit message using heredoc
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            git commit -m "$(cat <<'EOF'
          chore: Auto-sync HA add-on from main repository

          - Synchronized src/ and frontend/ to printernizer/
          - Version bumped in config.yaml
          - Updated CHANGELOG.md

          ðŸ¤– Automated sync via GitHub Actions
          EOF
          )"
          else
            git commit -m "$(cat <<'EOF'
          chore: Sync HA add-on (branch: ${{ github.ref_name }})

          - Synchronized src/ and frontend/ to printernizer/

          ðŸ¤– Automated sync via GitHub Actions
          EOF
          )"
          fi

          git push

      - name: Create sync summary
        if: steps.check_source_changes.outputs.source_changed == 'true' || steps.check_changes.outputs.changes == 'true'
        run: |
          echo "## âœ… Home Assistant Add-on Sync Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff HEAD~1 --stat printernizer/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.check_source_changes.outputs.source_changed == 'false' && steps.check_changes.outputs.changes == 'false'
        run: |
          echo "## â„¹ï¸ No Sync Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Home Assistant add-on code is already up to date." >> $GITHUB_STEP_SUMMARY
